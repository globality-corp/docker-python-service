#
# CircleCI Configuration for publishing a Python service using AWS CodeDeploy.
#
#
# - This script will require setting the $GEMFURY_REPO_URL in CircleCI,
#    under Project Settings -> Environment Variables.
# - Using `pip install` with --extra-index-url below allows for package dependencies
#   using the private repository as well.
# - We use nose for running unit-tests below using `python setup.py nosetests`
# - See the 'codedeploy' section under 'deployment' for appropriate mappings between the different
#   code branches (master, develop) and AWS CodeDeploy Deployment Groups / settings
# - Make sure to include the build.sh script used below in your codebase, available here:
#       https://gist.github.com/adamhadani/e79dcf9bf676a2f4d298
#
########################################################################################################
machine:
  services:
    - docker

dependencies:
  override:
    - BUILD_TAG={CIRCLE_BRANCH}-{CIRCLE_SHA1}
    - echo $BUILD_TAG
    - docker info
    - docker build -t python-service:{CIRCLE_BRANCH}-{CIRCLE_SHA1} .

deployment:
  hub:
    branch: feature/circleci
    commands:
      - echo $BUILD_TAG
      - eval $(aws ecr get-login --region us-east-1)
      - docker tag python-service:{CIRCLE_BRANCH}-{CIRCLE_SHA1} 021749107756.dkr.ecr.us-east-1.amazonaws.com/python-service:{CIRCLE_BRANCH}-{CIRCLE_SHA1}
      - docker push 021749107756.dkr.ecr.us-east-1.amazonaws.com/python-service:{CIRCLE_BRANCH}-{CIRCLE_SHA1}

  test:
    override:
      - echo "Successfully built new image!"
