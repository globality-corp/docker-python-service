#
# CircleCI Configuration for publishing a Python service using AWS CodeDeploy.
#
#
# - This script will require setting the $GEMFURY_REPO_URL in CircleCI,
#    under Project Settings -> Environment Variables.
# - Using `pip install` with --extra-index-url below allows for package dependencies
#   using the private repository as well.
# - We use nose for running unit-tests below using `python setup.py nosetests`
# - See the 'codedeploy' section under 'deployment' for appropriate mappings between the different
#   code branches (master, develop) and AWS CodeDeploy Deployment Groups / settings
# - Make sure to include the build.sh script used below in your codebase, available here:
#       https://gist.github.com/adamhadani/e79dcf9bf676a2f4d298
#
########################################################################################################
machine:
  services:
    - docker

dependencies:
  override:
    - BUILD_TAG=$(echo $CIRCLE_BRANCH | tr '/' '_')-$CIRCLE_SHA1
    - docker build -t python-service:$(echo $CIRCLE_BRANCH | tr '/' '_')-$CIRCLE_SHA1 .

test:
  override:
    - echo "Successfully built new image!"

deployment:
  hub:
    branch: feature/circleci
    commands:
      - BUILD_TAG=$(echo $CIRCLE_BRANCH | tr '/' '_')-$CIRCLE_SHA1
      - eval $(aws ecr get-login --region us-east-1)
      - docker tag python-service:$BUILD_TAG 021749107756.dkr.ecr.us-east-1.amazonaws.com/python-service:$BUILD_TAG
      - docker push 021749107756.dkr.ecr.us-east-1.amazonaws.com/python-service:$BUILD_TAG
